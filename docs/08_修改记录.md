# 代码修改记录

> 记录要求：每次代码编写或修改后，追加一条记录，至少包含时间、修改原因、修改后的效果/影响（含是否验证与结果）。

## 记录模板

- 时间：YYYY-MM-DD HH:MM (UTC±HH:MM)
- 修改范围：
- 修改原因：
- 修改后的效果/影响：
- 验证/结果：

## 记录条目

- 时间：2026-01-28 22:02 (UTC+08:00)
- 修改范围：`CLAUDE.md`
- 修改原因：明确“代码改动后必须记录原因、效果与时间”的项目规范，便于追踪与回溯。
- 修改后的效果/影响：新增变更记录要求，后续开发需在本文件追加条目。
- 验证/结果：不适用（文档规范更新）。

- 时间：2026-01-28 22:45 (UTC+08:00)
- 修改范围：`src/utils/astra_adapter.py`、`experiments/run_cross_domain_test.py`、`experiments/run_cross_domain_test_ns3.py`
- 修改原因：analytical congestion-aware 后端不支持 2D 拓扑，需要引入 NS3 后端来跑“域内/域间”2D 多域场景，同时保留原 analytical 测试入口。
- 修改后的效果/影响：
  - 增加 NS3 运行封装（`run_astra_ns3`）、逻辑拓扑生成（`logical-dims`）与 NS3 二进制自动定位。
  - `run_cross_domain_test.py` 支持 `--backend ns3` 跑 2D（多域）AllReduce；默认仍可跑 analytical（1D aware/unaware）。
- 验证/结果：已运行 `python experiments/run_cross_domain_test.py --backend ns3`，成功输出 cycles/comm/util 指标与日志（见 `results/cross_domain_test_ns3_4x4_domainring/`）。

- 时间：2026-01-28 22:55 (UTC+08:00)
- 修改范围：`astra-sim/extern/network_backend/ns-3-src/scratch/topology/20_nodes_4_switch_domain_ring_4x4_topology.txt`、`astra-sim/extern/network_backend/ns-3-src/scratch/config/config_domain_ring_4x4.txt`
- 修改原因：让 NS3 物理拓扑具备“域内高速、域间慢链路”的语义一致性，并修复 NS3 对链路速率映射（KMIN/KMAX）缺失导致的崩溃。
- 修改后的效果/影响：
  - 新增 4 域×4 GPU 的“每域 ToR + ToR ring”物理拓扑文件与对应 config。
  - 为 3200Gbps 链路补齐 `KMIN/KMAX/PMAX` 映射，避免 NS3 assert（`must set kmin for each link speed`）。
- 验证/结果：已用该 config 完整跑通一次 NS3 2D 仿真，日志包含 `sys[i] finished` 与 `Average compute utilization` 统计（见 `results/cross_domain_test_ns3_4x4_domainring/ns3/ns3_2d.log`）。

- 时间：2026-01-28 23:00 (UTC+08:00)
- 修改范围：`experiments/train_hi_ppo.py`、`configs/algo/hi_ppo_ns3_4x4_one_round.yaml`
- 修改原因：为 Hi-PPO 训练引入 NS3 2D 多域配置参数与最小化训练配置，完成“真实 NS3 2D 一轮训练”验证。
- 修改后的效果/影响：
  - `train_hi_ppo.py` 支持从 YAML 读取工作负载类型与 NS3 相关参数（out_dir、results_path、allreduce 等）。
  - 新增 4 域×4 GPU 的 NS3 2D 训练配置（单步 rollout），用于快速验证训练闭环。
- 验证/结果：运行 `python experiments/train_hi_ppo.py --config configs/algo/hi_ppo_ns3_4x4_one_round.yaml --timesteps 1` 成功产出训练统计与 NS3 日志（`results/training/training_stats.json`、`results/ns3_4x4_train_stats.csv`、`results/astra_stdout.log`）。

- 时间：2026-01-28 23:12 (UTC+08:00)
- 修改范围：`src/algorithms/hi_ppo/trainer.py`
- 修改原因：在 macOS 上启用 MPS 加速，避免 Hi-PPO 训练默认落到 CPU。
- 修改后的效果/影响：设备选择顺序变为 CUDA → MPS → CPU，macOS 可自动使用 GPU。
- 验证/结果：通过 `torch.backends.mps.is_available()` 运行检测为 True（本机可用）。

- 时间：2026-01-28 23:30 (UTC+08:00)
- 修改范围：`src/envs/astra_env.py`、`experiments/train_hi_ppo.py`、`astra-sim/extern/network_backend/ns-3-src/scratch/topology/20_nodes_4_switch_domain_ring_4x4_bottleneck50_topology.txt`、`astra-sim/extern/network_backend/ns-3-src/scratch/config/config_domain_ring_4x4_bottleneck50.txt`、`configs/algo/hi_ppo_ns3_4x4_burst_bottleneck.yaml`
- 修改原因：提升跨域调度差异可观测性，引入“突发通信”负载与“跨域瓶颈链路”拓扑场景。
- 修改后的效果/影响：
  - 环境支持按步数周期切换 AllReduce 通信规模（突发通信），可用列表/周期配置。
  - 新增 4x4 域间 ring 中单链路 50Gbps 瓶颈的 NS3 物理拓扑与 config（含 KMIN/KMAX/PMAX 映射）。
  - 提供可直接跑的 burst + bottleneck 训练配置示例。
- 验证/结果：配置与代码已就绪，未额外运行（可用 `configs/algo/hi_ppo_ns3_4x4_burst_bottleneck.yaml` 启动）。

- 时间：2026-01-29 00:12 (UTC+08:00)
- 修改范围：`astra-rl` conda 环境（依赖安装）
- 修改原因：PyTorch Geometric 缺失导致 GNN 编码器回退到统计特征编码，需要启用真实 GNN。
- 修改后的效果/影响：在 `astra-rl` 环境安装 `pyg`（依赖栈自动匹配），启用 GraphSAGE/GAT/GCN。
- 验证/结果：`conda run -n astra-rl python -c "import torch_geometric; import torch_geometric.nn as nn; print(nn.SAGEConv)"` 成功。

- 时间：2026-01-29 00:25 (UTC+08:00)
- 修改范围：`src/algorithms/hi_ppo/trainer.py`
- 修改原因：希望在 PPO 训练过程中看到明确的进度反馈。
- 修改后的效果/影响：训练时启用 tqdm 进度条（若可用），并在无完整 episode 时避免输出 NaN 平均奖励。
- 验证/结果：代码编译通过（`python -m py_compile src/algorithms/hi_ppo/trainer.py`）。

- 时间：2026-01-29 00:31 (UTC+08:00)
- 修改范围：`src/algorithms/hi_ppo/trainer.py`
- 修改原因：NS3 单步仿真耗时较长，需在每个 step 开始时打印提示避免误判卡死。
- 修改后的效果/影响：每个训练 step 开始前输出 `[Step i] started` 日志。
- 验证/结果：代码编译通过（`python -m py_compile src/algorithms/hi_ppo/trainer.py`）。

- 时间：2026-01-29 00:40 (UTC+08:00)
- 修改范围：`experiments/train_hi_ppo.py`、`src/algorithms/hi_ppo/trainer.py`
- 修改原因：部分终端/IDE 对 stdout/stderr 缓冲导致训练日志延迟显示。
- 修改后的效果/影响：训练脚本启用行缓冲输出，关键日志打印强制 flush，确保尽快可见。
- 验证/结果：代码编译通过（`python -m py_compile experiments/train_hi_ppo.py src/algorithms/hi_ppo/trainer.py`）。

- 时间：2026-01-29 00:46 (UTC+08:00)
- 修改范围：`src/algorithms/hi_ppo/trainer.py`
- 修改原因：conda/IDE 仍可能吞掉 stdout，需确保训练过程可观测。
- 修改后的效果/影响：新增实时日志文件 `results/training/train_live.log`，每个 step 开始与关键节点写入并 flush。
- 验证/结果：代码编译通过（`python -m py_compile src/algorithms/hi_ppo/trainer.py`）。

- 时间：2026-01-29 01:05 (UTC+08:00)
- 修改范围：`src/algorithms/hi_ppo/trainer.py`、`src/envs/astra_env.py`
- 修改原因：提升训练鲁棒性与可读性（异常时资源清理、episode 统计可用）。
- 修改后的效果/影响：
  - 训练循环加入 `try/finally`，确保进度条与实时日志文件始终关闭。
  - `AstraSimEnv.step()` 支持基于 `episode_length` 的截断终止，episodes/avg_reward 可统计。
- 验证/结果：代码编译通过（`python -m py_compile src/algorithms/hi_ppo/trainer.py src/envs/astra_env.py`）。

- 时间：2026-01-29 01:15 (UTC+08:00)
- 修改范围：`src/envs/astra_env.py`、`experiments/train_hi_ppo.py`
- 修改原因：运行时 `EnvConfig` 缺少 `episode_length` 字段导致崩溃。
- 修改后的效果/影响：为 `EnvConfig` 增加 `episode_length`（默认 128），并在训练配置加载时传入该字段。
- 验证/结果：代码编译通过（`python -m py_compile src/envs/astra_env.py experiments/train_hi_ppo.py`）。

- 时间：2026-01-31 10:14 (UTC+08:00)
- 修改范围：`src/envs/astra_env.py`、`src/algorithms/reward_functions.py`、`src/algorithms/hi_ppo/buffer.py`、`src/algorithms/hi_ppo/networks.py`、`src/utils/gnn_encoder.py`
- 修改原因：修复 code review 中发现的奖励动作失联、多域 GPU 映射错误、NS3 观测不一致、buffer 越界与单域策略崩溃等问题。
- 修改后的效果/影响：
  - AllReduce 模式可选择使用 placement 估算通信成本，使奖励对动作可敏感。
  - 多域模式将域级 placement 展开为 GPU 级 placement，避免仅前几个 GPU 有计算节点。
  - NS3 后端默认使用静态网络状态，降低观测与仿真不一致风险（可配置）。
  - RolloutBuffer 增加溢出保护；单域(num_domains=1)策略网络可安全运行。
  - GraphSAGE/GCN 自动禁用 edge features 并提示，避免配置误解。
- 验证/结果：代码编译通过（`python -m py_compile src/envs/astra_env.py src/algorithms/reward_functions.py src/algorithms/hi_ppo/buffer.py src/algorithms/hi_ppo/networks.py src/utils/gnn_encoder.py`）。

- 时间：2026-01-31 10:18 (UTC+08:00)
- 修改范围：`src/utils/gnn_encoder.py`
- 修改原因：GNNConfig 为 frozen dataclass，运行时修改字段导致 `FrozenInstanceError`。
- 修改后的效果/影响：不再修改配置对象，仅提示 GraphSAGE/GCN 会忽略 edge features。
- 验证/结果：代码编译通过（`python -m py_compile src/utils/gnn_encoder.py`）。

- 时间：2026-01-31 10:21 (UTC+08:00)
- 修改范围：`configs/algo/hi_ppo.yaml`
- 修改原因：希望启用边特征，使用支持 edge features 的 GAT 编码器。
- 修改后的效果/影响：GNN 模型默认切换为 GAT，新增 `num_heads` 配置项。
- 验证/结果：代码编译通过（`python -m py_compile src/utils/astra_adapter.py`）。

- 时间：2026-01-31 10:51 (UTC+08:00)
- 修改范围：`src/envs/astra_env.py`、`experiments/train_hi_ppo.py`、`configs/algo/hi_ppo.yaml`
- 修改原因：实现 NS3 动态网络配置，并允许通过配置开关启用。
- 修改后的效果/影响：
  - NS3 后端启用 `ns3_use_dynamic_network_state` 时每步重写 topology 文件，动态注入带宽/延迟。
  - 训练脚本支持从 YAML 读取 `ns3_use_dynamic_network_state`。
  - 配置文件新增 `ns3_use_dynamic_network_state` 开关（默认 false）。
- 验证/结果：代码编译通过（`python -m py_compile src/envs/astra_env.py experiments/train_hi_ppo.py`）。

- 时间：2026-01-31 10:54 (UTC+08:00)
- 修改范围：`src/utils/astra_adapter.py`
- 修改原因：NS3 训练出现 `No dependancy free nodes found`，部分 GPU trace 为空导致死锁。
- 修改后的效果/影响：对无节点的 NPU 自动注入最小 `idle_compute` 节点，避免空 trace。
- 验证/结果：代码编译通过（`python -m py_compile src/utils/astra_adapter.py`）。

- 时间：2026-01-31 11:58 (UTC+08:00)
- 修改范围：`astra-sim/extern/network_backend/ns-3-src/scratch/common.h`
- 修改原因：实现 NS3 内部链路动态更新（link update schedule），避免仅靠每步重启仿真模拟“动态”。
- 修改后的效果/影响：
  - 支持在 NS3 config 中配置 `LINK_UPDATE_SCHEDULE`，读取更新事件并在仿真中定时更新链路带宽/延迟。
  - 更新后重新计算路由与 RTT/BDP，并更新交换机 `MaxRtt`。
- 验证/结果：未运行（未执行本地编译/仿真）。

- 时间：2026-01-31 11:59 (UTC+08:00)
- 修改范围：`configs/ns3_link_update_schedule_example.txt`
- 修改原因：提供 NS3 动态链路更新 schedule 示例，便于配置与验证。
- 修改后的效果/影响：新增示例文件，可直接在 NS3 config 中引用 `LINK_UPDATE_SCHEDULE`。
- 验证/结果：未运行（示例文件）。

- 时间：2026-01-31 13:55 (UTC+08:00)
- 修改范围：`astra-sim/extern/network_backend/ns-3-src/scratch/config/config_domain_ring_4x4.txt`、`astra-sim/extern/network_backend/ns-3-src/scratch/config/config_domain_ring_8x8.txt`
- 修改原因：启用 NS3 动态链路更新 schedule。
- 修改后的效果/影响：配置文件新增 `LINK_UPDATE_SCHEDULE` 指向示例 schedule 文件。
- 验证/结果：NS3 后端已重新编译（`astra-sim/build/astra_ns3/build.sh`），并通过短测试（`python experiments/run_cross_domain_test_ns3.py --out-dir results/cross_domain_test_ns3_dynamic_short --data-size-mb 1 --num-iterations 1 --compute-us 100`）。

- 时间：2026-01-31 16:20 (UTC+08:00)
- 修改范围：`src/envs/astra_env.py`
- 修改原因：静态 NS3 模式下观测仍来自 NetworkDynamics，可能与真实拓扑不一致。
- 修改后的效果/影响：从 NS3 配置解析 `TOPOLOGY_FILE`，按最短时延路径估算域间带宽/延迟矩阵，观测与仿真拓扑对齐（解析失败则回退）。
- 验证/结果：未运行（代码改动）。

- 时间：2026-01-31 17:05 (UTC+08:00)
- 修改范围：`src/envs/astra_env.py`
- 修改原因：NS3 动态模式下 topology 与域数不匹配或链路无法更新时，观测仍按动态状态输出，导致观测与仿真不一致。
- 修改后的效果/影响：
  - 启动时预检查 NS3 topology 与 `num_domains` 是否一致，不满足则自动回退到静态观测。
  - 动态拓扑写入失败时自动回退静态观测，并同步更新 `network_state`，降低不一致风险。
  - `info` 中新增 `ns3_dynamic_enabled` 字段便于训练侧感知当前模式。
- 验证/结果：未运行（代码改动）。

- 时间：2026-01-31 17:40 (UTC+08:00)
- 修改范围：`src/envs/astra_env.py`、`experiments/train_hi_ppo.py`
- 修改原因：NS3 启用 `LINK_UPDATE_SCHEDULE` 后，观测未反映链路随时间更新的状态。
- 修改后的效果/影响：
  - 解析 schedule 并按 `ns3_schedule_observation_time_ms` 采样链路状态，观测与仿真时间点一致。
  - 允许在配置中显式指定 `ns3_link_update_schedule`（优先于 NS3 config）。
  - 为静态 NS3 观测缓存引入 schedule/time 维度，避免使用旧观测。
- 验证/结果：通过 `python -m py_compile src/envs/astra_env.py experiments/train_hi_ppo.py`；并用短测与脚本验证 schedule 在观测中生效。

- 时间：2026-01-31 18:10 (UTC+08:00)
- 修改范围：`src/envs/astra_env.py`、`experiments/train_hi_ppo.py`
- 修改原因：需要让观测时间随“每 step 实际仿真耗时”推进，以匹配 NS3 内部动态链路时间轴。
- 修改后的效果/影响：
  - 增加 wall-time 推进策略：每步测量仿真耗时并累加，用于 schedule 观测时间。
  - `info` 中增加 `sim_elapsed_ms` 与 `ns3_schedule_observation_time_ms` 便于对齐调试。
  - 训练配置可通过 `ns3_schedule_use_wall_time` 开关控制。
- 验证/结果：未运行（代码改动）。

- 时间：2026-01-31 18:30 (UTC+08:00)
- 修改范围：`configs/ns3_link_update_schedule_domain_ring_8x8.txt`、`astra-sim/extern/network_backend/ns-3-src/scratch/config/config_domain_ring_8x8.txt`
- 修改原因：8x8 域环拓扑的 switch ID 为 64-71，原 schedule 使用 16-17 不生效。
- 修改后的效果/影响：为 8x8 场景提供匹配 switch ID 的 schedule，并更新 NS3 config 引用，确保动态链路生效。
- 验证/结果：未运行（配置改动）。

- 时间：2026-01-31 19:05 (UTC+08:00)
- 修改范围：`src/envs/astra_env.py`、`experiments/train_hi_ppo.py`、`tools/generate_ns3_schedule.py`
- 修改原因：P0 优先项落地：观测现实化（部分可观测/噪声/延迟）与动态 schedule 自动生成。
- 修改后的效果/影响：
  - Env 增加 `observation_mode/observation_delay_steps/observation_noise_*`，支持聚合观测与测量噪声。
  - 训练配置支持读取上述观测参数。
  - 新增脚本自动生成 `LINK_UPDATE_SCHEDULE`（从 NetworkDynamics 输出映射到拓扑链路）。
- 验证/结果：通过 `python -m py_compile src/envs/astra_env.py experiments/train_hi_ppo.py`。

- 时间：2026-01-31 19:25 (UTC+08:00)
- 修改范围：`configs/algo/hi_ppo.yaml`、`configs/algo/hi_ppo_ns3_4x4_one_round.yaml`、`astra-sim/extern/network_backend/ns-3-src/scratch/config/config_domain_ring_4x4.txt`、`configs/ns3_link_update_schedule_domain_ring_4x4.txt`、`configs/ns3_link_update_schedule_domain_ring_8x8.txt`
- 修改原因：继续落地 P0：在默认训练配置中启用现实化观测，并为 4x4/8x8 域环拓扑生成真实动态 schedule。
- 修改后的效果/影响：
  - 默认配置启用 aggregate 观测 + 噪声 + 延迟。
  - 4x4 NS3 config 指向新生成的 schedule，8x8 schedule 同步更新。
- 验证/结果：通过 `python tools/generate_ns3_schedule.py ...` 生成 schedule（6 steps）。

- 时间：2026-01-31 19:50 (UTC+08:00)
- 修改范围：`tools/compare_observations.py`、`tools/plot_training_rewards.py`
- 修改原因：需要观测可视化/对比脚本，并快速查看训练 reward 曲线。
- 修改后的效果/影响：
  - 新增观测对比脚本，输出 CSV + 可选 PNG。
  - 新增 reward 曲线绘图脚本（无 matplotlib 时输出 CSV）。
- 验证/结果：未运行（脚本新增）。

- 时间：2026-01-31 20:15 (UTC+08:00)
- 修改范围：`configs/algo/hi_ppo_ns3_4x4_short.yaml`
- 修改原因：短时 NS3 训练测试需要更小的 workload 与更短 episode。
- 修改后的效果/影响：提供 4x4 NS3 短训配置（1MB/1 iter/100us，episode_length=8）。
- 验证/结果：未运行（配置新增）。

- 时间：2026-01-31 20:35 (UTC+08:00)
- 修改范围：`results/observation_compare/observation_compare.csv`、`results/observation_compare/observation_compare.png`、`results/training/training_stats.json`、`results/training/reward_curve_short_ns3.png`
- 修改原因：根据 P0 任务要求，生成观测对比可视化，并运行短 NS3 训练以观察 reward 曲线。
- 修改后的效果/影响：
  - 观测对比输出 CSV+PNG（30 步，aggregate+噪声+延迟）。
  - 完成 8 步 NS3 短训并输出 reward 曲线图。
- 验证/结果：已运行 `python tools/compare_observations.py ...`、`python experiments/train_hi_ppo.py --config configs/algo/hi_ppo_ns3_4x4_short.yaml --timesteps 8`、`python tools/plot_training_rewards.py ...`。

- 时间：2026-01-31 21:05 (UTC+08:00)
- 修改范围：`configs/algo/hi_ppo_ns3_4x4_short_clean.yaml`、`results/training/training_stats_clean.json`、`results/training/training_stats_noisy.json`、`results/training/reward_curve_clean.png`、`results/training/reward_curve_noisy.png`
- 修改原因：对比 aggregate 观测的“干净 vs 噪声+延迟”训练表现。
- 修改后的效果/影响：
  - 新增干净观测短训配置。
  - 运行两次 32 步短训并保存对比曲线与统计。
- 验证/结果：已运行 `python experiments/train_hi_ppo.py --config ...short_clean.yaml --timesteps 32` 与 `...short.yaml --timesteps 32`，并生成 reward 曲线图。

- 时间：2026-01-31 21:25 (UTC+08:00)
- 修改范围：`CLAUDE.md`
- 修改原因：需要明确“每次修改代码需中文详细 commit 并推送到 GitHub”的提交规范。
- 修改后的效果/影响：新增提交要求条目，约束后续提交信息必须详述范围、原因与效果。
- 验证/结果：不适用（文档规范更新）。

- 时间：2026-01-31 23:53 (UTC+08:00)
- 修改范围：`src/algorithms/hi_ppo/ppo_agent.py`、`src/algorithms/hi_ppo/buffer.py`、`src/algorithms/hi_ppo/trainer.py`、`src/algorithms/hi_ppo/networks.py`、`src/utils/gnn_encoder.py`
- 修改原因：根据 code review 结果修复 PPO 早停性能问题、缓冲区尺寸同步、日志资源管理与输出过量问题，并补齐可训练 GNN 的数据通道与参数保存。
- 修改后的效果/影响：
  - PPO 早停不再重复构造 batch 生成器，buffer_size 与 rollout 步数显式对齐。
  - GNN 编码支持可选端到端训练与权重保存/加载，训练时可重算拓扑特征。
  - 训练日志文件使用上下文管理，步进日志降频，解释性历史长度可控。
  - 修正类型注解与就地更新，优势归一化与 Adam eps 配置化。
- 验证/结果：未运行（代码修改）。

- 时间：2026-02-01 00:32 (UTC+08:00)
- 修改范围：`src/envs/astra_env.py`
- 修改原因：mock 模式运行时仍强制生成 ET 工作负载，导致缺失 Chakra protobuf 时直接失败。
- 修改后的效果/影响：mock 模式下跳过工作负载 ET 生成，避免对 Chakra 的硬依赖，`run_mock_episode.py` 可直接跑通。
- 验证/结果：已运行 `python experiments/run_mock_episode.py` 成功。
